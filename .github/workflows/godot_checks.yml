name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "master", "dev" ]
    tags: [ "v*" ]
  pull_request:

permissions:
  contents: write

jobs:
  test:
    name: üß™ Run Tests
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.5.1
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup
        run: |
          mkdir -p ~/.config/godot
      
      - name: Import Project (Generate Cache)
        run: godot --headless --editor --quit
          
      - name: Run Dynamic Tests
        timeout-minutes: 15
        run: |
          echo "üîç Discovering Tests..."
          FAIL=0
          
          # 1. Run all Test Scenes (*.tscn)
          find tests -name "*.tscn" | while read -r scene; do
            echo "üé¨ Running Scene: $scene"
            godot --headless --path . "$scene"
            if [ $? -ne 0 ]; then
                echo "‚ùå FAILURE in $scene"
                touch .test_failed
                FAIL=1
            fi
          done
          
          # 2. Run Standalone Scripts
          find tests -name "*.gd" | while read -r script; do
            if grep -q -E "extends\s+(SceneTree|MainLoop)" "$script"; then
              echo "üìú Running Script: $script"
              godot --headless -s "$script"
              if [ $? -ne 0 ]; then
                  echo "‚ùå FAILURE in $script"
                  touch .test_failed
                  FAIL=1
              fi
            fi
          done
          
          if [ -f .test_failed ]; then
            echo "üî• SOME TESTS FAILED"
            exit 1
          else
             echo "‚úÖ ALL TESTS PASSED"
          fi

  build:
    name: üì¶ Build
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.5.1
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Export Dir
        run: mkdir -p build/windows build/web

      - name: Install Export Templates
        run: |
          mkdir -p ~/.local/share/godot/export_templates/4.5.1.stable
          wget -q https://github.com/godotengine/godot/releases/download/4.5.1-stable/Godot_v4.5.1-stable_export_templates.tpz
          unzip -q Godot_v4.5.1-stable_export_templates.tpz
          mv templates/* ~/.local/share/godot/export_templates/4.5.1.stable/
          rm -rf templates Godot_v4.5.1-stable_export_templates.tpz
        
      - name: Export Windows
        run: |
          godot --headless --export-release "Windows Desktop" build/windows/Bark.exe
          
      - name: Export Web
        run: |
          godot --headless --export-release "Web" build/web/index.html

      - name: Zip Builds
        run: |
          apt-get update && apt-get install -y zip
          cd build/windows && zip -r ../../windows_build.zip . && cd ../..
          cd build/web && zip -r ../../web_build.zip . && cd ../..

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: windows_build.zip
          
      - name: Upload Web Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: web_build.zip

  deploy_itch:
    name: üöÄ Deploy to itch.io
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    
    steps:
      - name: Download Windows Build
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          
      - name: Download Web Build
        uses: actions/download-artifact@v4
        with:
          name: web-build

      - name: Deploy Windows
        uses: manleydev/butler-publish-itchio-action@master
        env:
          BUTLER_CREDENTIALS: ${{ secrets.BUTLER_CREDENTIALS }}
          CHANNEL: windows
          ITCH_GAME: bark-com
          ITCH_USER: smilidog
          PACKAGE: windows_build.zip
          VERSION: ${{ github.ref_name }}

      - name: Deploy Web
        uses: manleydev/butler-publish-itchio-action@master
        env:
          BUTLER_CREDENTIALS: ${{ secrets.BUTLER_CREDENTIALS }}
          CHANNEL: web
          ITCH_GAME: bark-com
          ITCH_USER: smilidog
          PACKAGE: web_build.zip
          VERSION: ${{ github.ref_name }}

  release_github:
    name: üè∑Ô∏è Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Download Windows Build
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          
      - name: Download Web Build
        uses: actions/download-artifact@v4
        with:
          name: web-build

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            windows_build.zip
            web_build.zip
          fail_on_unmatched_files: true
